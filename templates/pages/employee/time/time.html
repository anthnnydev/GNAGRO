{% extends 'layouts/base_employee.html' %}

{% block title %}Mi Horario - Portal Empleado{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Meta tag para CSRF -->
    <meta name="csrf-token" content="{{ csrf_token }}">
    
    <!-- Header de la página -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-clock text-blue-600 mr-3"></i>
                        Control de Tiempo y Asistencia
                    </h1>
                    <p class="text-gray-600 mt-1">Gestiona tu horario y registra tu asistencia</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        {% now "l, d F Y" %}
                    </div>
                    <div class="text-sm text-blue-600 bg-blue-100 rounded-lg px-3 py-2" id="current-time">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="time-display">--:--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Estadísticas del mes -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Horas trabajadas este mes -->
            <div class="bg-white rounded-xl shadow-lg border-l-4 border-green-500 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Horas Este Mes</p>
                        <p class="text-3xl font-bold text-green-600">{{ monthly_hours|floatformat:1|default:0 }}</p>
                        <p class="text-sm text-green-600 mt-1">
                            <i class="fas fa-calendar mr-1"></i>
                            {{ "now"|date:"F" }}
                        </p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-hourglass-half text-green-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Horas extra -->
            <div class="bg-white rounded-xl shadow-lg border-l-4 border-orange-500 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Horas Extra</p>
                        <p class="text-3xl font-bold text-orange-600">{{ overtime_hours|floatformat:1|default:0 }}</p>
                        <p class="text-sm text-orange-600 mt-1">
                            <i class="fas fa-plus mr-1"></i>
                            Adicionales
                        </p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-clock text-orange-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Días trabajados -->
            <div class="bg-white rounded-xl shadow-lg border-l-4 border-blue-500 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Días Trabajados</p>
                        <p class="text-3xl font-bold text-blue-600">{{ days_worked|default:0 }}</p>
                        <p class="text-sm text-blue-600 mt-1">
                            <i class="fas fa-calendar-check mr-1"></i>
                            Este mes
                        </p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <!-- Promedio diario -->
            <div class="bg-white rounded-xl shadow-lg border-l-4 border-purple-500 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Promedio Diario</p>
                        <p class="text-3xl font-bold text-purple-600">{{ daily_average|default:0.0 }}</p>
                        <p class="text-sm text-purple-600 mt-1">
                            <i class="fas fa-chart-line mr-1"></i>
                            Horas/día
                        </p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-calculator text-purple-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control de asistencia en tiempo real -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- Panel de marcado -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                    <i class="fas fa-fingerprint text-blue-500 mr-2"></i>
                    Control de Asistencia
                </h3>
                
                <div class="space-y-6">
                    <!-- Estado actual -->
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-lg font-medium text-gray-900">Estado Actual</h4>
                                <p class="text-sm text-gray-600" id="work-status">Fuera de horario laboral</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600" id="session-time">00:00:00</div>
                                <p class="text-xs text-gray-500">Tiempo de sesión</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de control -->
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clock-in-btn" 
                                class="bg-green-600 text-white px-6 py-4 rounded-lg hover:bg-green-700 transition-colors flex flex-col items-center">
                            <i class="fas fa-sign-in-alt text-2xl mb-2"></i>
                            <span class="font-medium">Marcar Entrada</span>
                            <span class="text-xs opacity-75">Iniciar jornada</span>
                        </button>
                        
                        <button id="clock-out-btn" 
                                class="bg-red-600 text-white px-6 py-4 rounded-lg hover:bg-red-700 transition-colors flex flex-col items-center disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                            <i class="fas fa-sign-out-alt text-2xl mb-2"></i>
                            <span class="font-medium">Marcar Salida</span>
                            <span class="text-xs opacity-75">Finalizar jornada</span>
                        </button>
                        
                        <button id="break-start-btn" 
                                class="bg-yellow-600 text-white px-6 py-4 rounded-lg hover:bg-yellow-700 transition-colors flex flex-col items-center disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                            <i class="fas fa-coffee text-2xl mb-2"></i>
                            <span class="font-medium">Iniciar Descanso</span>
                            <span class="text-xs opacity-75">Pausa</span>
                        </button>
                        
                        <button id="break-end-btn" 
                                class="bg-blue-600 text-white px-6 py-4 rounded-lg hover:bg-blue-700 transition-colors flex flex-col items-center disabled:opacity-50 disabled:cursor-not-allowed" 
                                disabled>
                            <i class="fas fa-play text-2xl mb-2"></i>
                            <span class="font-medium">Finalizar Descanso</span>
                            <span class="text-xs opacity-75">Continuar</span>
                        </button>
                    </div>
                    
                    <!-- Ubicación (opcional) -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-map-marker-alt text-gray-400"></i>
                                <span class="text-sm text-gray-600">Ubicación registrada</span>
                            </div>
                            <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="getLocation()">
                                <i class="fas fa-crosshairs mr-1"></i>Obtener ubicación
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" id="location-display">Sin ubicación registrada</p>
                    </div>
                </div>
            </div>
            
            <!-- Información del día -->
            <div class="space-y-6">
                <!-- Horario de hoy -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-calendar-day text-green-500 mr-2"></i>
                        Horario de Hoy
                    </h3>
                    
                    {% if current_schedule %}
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Horario asignado:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.name }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Entrada programada:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.start_time|time:"H:i" }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Salida programada:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.end_time|time:"H:i" }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Horas esperadas:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.daily_hours|floatformat:1 }} horas</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Descanso:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.break_duration }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Tolerancia:</span>
                            <span class="text-sm font-medium text-gray-900">{{ current_schedule.late_tolerance }} min</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-circle text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-600">No tienes horario asignado</p>
                        <p class="text-xs text-gray-500 mt-1">Contacta a RRHH para asignarte un horario</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Registro del día -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                        <i class="fas fa-list text-blue-500 mr-2"></i>
                        Registro de Hoy
                    </h3>
                    
                    <div class="space-y-3" id="daily-log">
                        {% if today_record %}
                            {% if today_record.clock_in %}
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-sign-in-alt text-green-600"></i>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Entrada registrada</p>
                                            <p class="text-xs text-gray-500">{{ today_record.clock_in|time:"H:i:s" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if today_record.break_start %}
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-coffee text-yellow-600"></i>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Descanso iniciado</p>
                                            <p class="text-xs text-gray-500">{{ today_record.break_start|time:"H:i:s" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if today_record.break_end %}
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-play text-blue-600"></i>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Descanso finalizado</p>
                                            <p class="text-xs text-gray-500">{{ today_record.break_end|time:"H:i:s" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            {% if today_record.clock_out %}
                                <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-sign-out-alt text-red-600"></i>
                                        <div>
                                            <p class="text-sm font-medium text-gray-900">Salida registrada</p>
                                            <p class="text-xs text-gray-500">{{ today_record.clock_out|time:"H:i:s" }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="text-center text-gray-500 py-4">
                                <i class="fas fa-clock text-gray-300 text-2xl mb-2"></i>
                                <p class="text-sm">No hay registros para hoy</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de asistencia -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <i class="fas fa-history text-purple-500 mr-2"></i>
                    Historial de Asistencia
                </h3>
                <div class="flex items-center space-x-2">
                    <select class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="this-month">Este mes</option>
                        <option value="last-month">Mes anterior</option>
                        <option value="this-year">Este año</option>
                    </select>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm" onclick="exportAttendanceData()">
                        <i class="fas fa-download mr-2"></i>Exportar
                    </button>
                </div>
            </div>

            {% if attendance_records %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Entrada
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Salida
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Tiempo de Descanso
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Horas Trabajadas
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for record in attendance_records %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ record.date|date:"d/m/Y" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ record.clock_in|time:"H:i"|default:"--:--" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ record.clock_out|time:"H:i"|default:"--:--" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {% if record.break_start and record.break_end %}
                                    {{ record.break_duration|default:"--" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {{ record.total_hours|floatformat:1 }}h
                                {% if record.overtime_hours > 0 %}
                                    <span class="text-orange-600">(+{{ record.overtime_hours|floatformat:1 }}h)</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if record.status == 'present' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                        Presente
                                    </span>
                                {% elif record.status == 'late' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                        Tardanza
                                    </span>
                                {% elif record.status == 'absent' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                        Ausente
                                    </span>
                                {% elif record.status == 'partial' %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 text-orange-800">
                                        Parcial
                                    </span>
                                {% else %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                        {{ record.get_status_display }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- Estado vacío -->
            <div class="text-center py-12">
                <div class="mx-auto w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-clock text-gray-400 text-3xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay registros de asistencia</h3>
                <p class="text-gray-600 mb-6">Comienza a marcar tu asistencia para ver tu historial aquí.</p>
                
                <!-- Guía rápida -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 max-w-md mx-auto">
                    <h4 class="text-sm font-medium text-blue-900 mb-2">¿Cómo funciona?</h4>
                    <ol class="text-sm text-blue-700 text-left space-y-1">
                        <li>1. Marca tu entrada al llegar al trabajo</li>
                        <li>2. Registra tus descansos durante el día</li>
                        <li>3. Marca tu salida al terminar la jornada</li>
                    </ol>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Información adicional -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
            <!-- Políticas de horario -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                    Políticas de Horario
                </h3>
                
                <div class="space-y-3">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Horario de trabajo</p>
                            {% if current_schedule %}
                                <p class="text-sm text-gray-600">{{ current_schedule.working_days|join:", " }}, {{ current_schedule.start_time|time:"H:i" }} - {{ current_schedule.end_time|time:"H:i" }}</p>
                            {% else %}
                                <p class="text-sm text-gray-600">Lunes a Viernes, 8:00 AM - 5:00 PM</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-coffee text-orange-500 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Tiempo de descanso</p>
                            {% if current_schedule %}
                                <p class="text-sm text-gray-600">{{ current_schedule.break_duration }} para almuerzo</p>
                            {% else %}
                                <p class="text-sm text-gray-600">1 hora para almuerzo, 2 descansos de 15 min</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-clock text-blue-500 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Tolerancia de entrada</p>
                            {% if current_schedule %}
                                <p class="text-sm text-gray-600">{{ current_schedule.late_tolerance }} minutos después de la hora programada</p>
                            {% else %}
                                <p class="text-sm text-gray-600">15 minutos después de la hora programada</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Tiempo extra</p>
                            <p class="text-sm text-gray-600">Requiere autorización previa del supervisor</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contacto y soporte -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-headset text-green-500 mr-2"></i>
                    Soporte y Contacto
                </h3>
                
                <div class="space-y-4">
                    <p class="text-sm text-gray-600">
                        ¿Tienes problemas con el registro de asistencia? Contacta al departamento de RRHH.
                    </p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center space-x-3">
                            <div class="bg-blue-100 p-2 rounded-lg">
                                <i class="fas fa-envelope text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Email</p>
                                <p class="text-sm text-gray-600">rrhh@gnagro.com</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="bg-green-100 p-2 rounded-lg">
                                <i class="fas fa-phone text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Extensión</p>
                                <p class="text-sm text-gray-600">Ext. 101</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <div class="bg-purple-100 p-2 rounded-lg">
                                <i class="fas fa-question-circle text-purple-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Centro de ayuda</p>
                                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">Ver guías →</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let isWorking = false;
    let isOnBreak = false;
    let workStartTime = null;
    let breakStartTime = null;
    let sessionTimer = null;
    let currentLocation = null;

    // URLs de las APIs
    const API_URLS = {
        clockIn: "{% url 'employees:api_clock_in' %}",
        clockOut: "{% url 'employees:api_clock_out' %}",
        breakStart: "{% url 'employees:api_break_start' %}",
        breakEnd: "{% url 'employees:api_break_end' %}",
        status: "{% url 'employees:api_attendance_status' %}"
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Actualizar reloj en tiempo real
        updateClock();
        setInterval(updateClock, 1000);

        // Event listeners para botones
        document.getElementById('clock-in-btn').addEventListener('click', clockIn);
        document.getElementById('clock-out-btn').addEventListener('click', clockOut);
        document.getElementById('break-start-btn').addEventListener('click', startBreak);
        document.getElementById('break-end-btn').addEventListener('click', endBreak);

        // Cargar estado actual desde el servidor
        loadCurrentStatus();

        // Animaciones para las tarjetas
        const cards = document.querySelectorAll('.bg-white');
        cards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease';
                
                requestAnimationFrame(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                });
            }, index * 100);
        });
    });

    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES', { 
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        document.getElementById('time-display').textContent = timeString;

        // Actualizar tiempo de sesión si está trabajando
        if (isWorking && workStartTime) {
            updateSessionTime();
        }
    }

    function updateSessionTime() {
        const now = new Date();
        const diff = now - workStartTime;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('session-time').textContent = timeString;
    }

    async function loadCurrentStatus() {
        try {
            const response = await fetch(API_URLS.status);
            const result = await response.json();
            
            if (result.success) {
                const data = result.data;
                
                isWorking = data.is_working;
                isOnBreak = data.is_on_break;
                
                // Configurar tiempo de inicio si está trabajando
                if (data.clock_in && isWorking) {
                    const today = new Date().toDateString();
                    workStartTime = new Date(`${today} ${data.clock_in}`);
                }
                
                // Actualizar UI con el estado actual
                updateUI();
                
                // Cargar registros del día si existen
                if (data.has_record) {
                    loadTodayLogs(data);
                }
                
                console.log('Estado cargado:', data);
            }
        } catch (error) {
            console.error('Error al cargar estado:', error);
        }
    }

    function loadTodayLogs(data) {
        const dailyLog = document.getElementById('daily-log');
        
        // Limpiar contenido existente
        dailyLog.innerHTML = '';
        
        // Agregar entrada si existe
        if (data.clock_in) {
            addLogEntryToDOM('Entrada registrada', data.clock_in, 'clock-in');
        }
        
        // Agregar inicio de descanso si existe
        if (data.break_start) {
            addLogEntryToDOM('Descanso iniciado', data.break_start, 'break-start');
        }
        
        // Agregar fin de descanso si existe
        if (data.break_end) {
            addLogEntryToDOM('Descanso finalizado', data.break_end, 'break-end');
        }
        
        // Agregar salida si existe
        if (data.clock_out) {
            addLogEntryToDOM('Salida registrada', data.clock_out, 'clock-out');
        }
        
        // Si no hay registros, mostrar mensaje
        if (!data.clock_in) {
            dailyLog.innerHTML = `
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-clock text-gray-300 text-2xl mb-2"></i>
                    <p class="text-sm">No hay registros para hoy</p>
                </div>
            `;
        }
    }

    async function clockIn() {
        try {
            const response = await makeAttendanceRequest(API_URLS.clockIn, {
                latitude: currentLocation?.lat,
                longitude: currentLocation?.lng
            });
            
            if (response.success) {
                isWorking = true;
                const today = new Date().toDateString();
                workStartTime = new Date(`${today} ${response.clock_in_time}`);
                
                updateUI();
                addLogEntry('Entrada registrada', new Date(), 'clock-in');
                
                showSuccessMessage(response.message);
                console.log('Entrada registrada:', response);
            } else {
                showErrorMessage(response.error);
            }
        } catch (error) {
            showErrorMessage('Error de conexión al registrar entrada');
            console.error('Error en clock in:', error);
        }
    }

    async function clockOut() {
        if (!isWorking) return;
        
        try {
            const response = await makeAttendanceRequest(API_URLS.clockOut, {
                latitude: currentLocation?.lat,
                longitude: currentLocation?.lng
            });
            
            if (response.success) {
                isWorking = false;
                isOnBreak = false;
                
                updateUI();
                addLogEntry('Salida registrada', new Date(), 'clock-out');
                
                // Mostrar resumen del día
                let message = `${response.message}\nHoras trabajadas: ${response.total_hours.toFixed(2)}h`;
                if (response.overtime_hours > 0) {
                    message += `\nHoras extras: ${response.overtime_hours.toFixed(2)}h`;
                }
                
                showSuccessMessage(message);
                console.log('Salida registrada:', response);
                
                // Recargar página después de 2 segundos para actualizar estadísticas
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showErrorMessage(response.error);
            }
        } catch (error) {
            showErrorMessage('Error de conexión al registrar salida');
            console.error('Error en clock out:', error);
        }
    }

    async function startBreak() {
        if (!isWorking || isOnBreak) return;
        
        try {
            const response = await makeAttendanceRequest(API_URLS.breakStart, {
                break_type: 'regular'
            });
            
            if (response.success) {
                isOnBreak = true;
                
                updateUI();
                addLogEntry('Descanso iniciado', new Date(), 'break-start');
                showSuccessMessage(response.message);
                console.log('Descanso iniciado:', response);
            } else {
                showErrorMessage(response.error);
            }
        } catch (error) {
            showErrorMessage('Error de conexión al iniciar descanso');
            console.error('Error en start break:', error);
        }
    }

    async function endBreak() {
        if (!isWorking || !isOnBreak) return;
        
        try {
            const response = await makeAttendanceRequest(API_URLS.breakEnd);
            
            if (response.success) {
                isOnBreak = false;
                
                updateUI();
                addLogEntry('Descanso finalizado', new Date(), 'break-end');
                showSuccessMessage(response.message);
                console.log('Descanso finalizado:', response);
            } else {
                showErrorMessage(response.error);
            }
        } catch (error) {
            showErrorMessage('Error de conexión al finalizar descanso');
            console.error('Error en end break:', error);
        }
    }

    async function makeAttendanceRequest(url, data = {}) {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(data)
        });
        
        return await response.json();
    }

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
               '';
    }

    function updateUI() {
        const clockInBtn = document.getElementById('clock-in-btn');
        const clockOutBtn = document.getElementById('clock-out-btn');
        const breakStartBtn = document.getElementById('break-start-btn');
        const breakEndBtn = document.getElementById('break-end-btn');
        const workStatus = document.getElementById('work-status');

        if (isWorking) {
            clockInBtn.disabled = true;
            clockInBtn.classList.add('opacity-50', 'cursor-not-allowed');
            clockOutBtn.disabled = false;
            clockOutBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            breakStartBtn.disabled = isOnBreak;
            breakEndBtn.disabled = !isOnBreak;
            
            if (isOnBreak) {
                breakStartBtn.classList.add('opacity-50', 'cursor-not-allowed');
                breakEndBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                workStatus.textContent = 'En descanso';
                workStatus.className = 'text-sm text-yellow-600';
            } else {
                breakStartBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                breakEndBtn.classList.add('opacity-50', 'cursor-not-allowed');
                workStatus.textContent = 'Trabajando';
                workStatus.className = 'text-sm text-green-600';
            }
        } else {
            clockInBtn.disabled = false;
            clockInBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            clockOutBtn.disabled = true;
            clockOutBtn.classList.add('opacity-50', 'cursor-not-allowed');
            breakStartBtn.disabled = true;
            breakStartBtn.classList.add('opacity-50', 'cursor-not-allowed');
            breakEndBtn.disabled = true;
            breakEndBtn.classList.add('opacity-50', 'cursor-not-allowed');
            workStatus.textContent = 'Fuera de horario laboral';
            workStatus.className = 'text-sm text-gray-600';
            document.getElementById('session-time').textContent = '00:00:00';
        }
    }

    function addLogEntry(action, time, type) {
        const timeString = time.toLocaleTimeString('es-ES', { 
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        addLogEntryToDOM(action, timeString, type);
    }

    function addLogEntryToDOM(action, timeString, type) {
        const dailyLog = document.getElementById('daily-log');
        
        // Remover mensaje de "no hay registros" si existe
        const emptyMessage = dailyLog.querySelector('.text-center');
        if (emptyMessage) {
            emptyMessage.remove();
        }
        
        const entry = document.createElement('div');
        entry.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg mb-2';
        
        const iconClass = {
            'clock-in': 'fas fa-sign-in-alt text-green-600',
            'clock-out': 'fas fa-sign-out-alt text-red-600',
            'break-start': 'fas fa-coffee text-yellow-600',
            'break-end': 'fas fa-play text-blue-600'
        }[type];
        
        entry.innerHTML = `
            <div class="flex items-center space-x-3">
                <i class="${iconClass}"></i>
                <div>
                    <p class="text-sm font-medium text-gray-900">${action}</p>
                    <p class="text-xs text-gray-500">${timeString}</p>
                </div>
            </div>
        `;
        
        // Insertar al inicio para mostrar los más recientes primero
        dailyLog.insertBefore(entry, dailyLog.firstChild);
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                currentLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                document.getElementById('location-display').textContent = 
                    `Lat: ${currentLocation.lat.toFixed(6)}, Lng: ${currentLocation.lng.toFixed(6)}`;
                
                showSuccessMessage('Ubicación obtenida correctamente');
                
            }, function(error) {
                showErrorMessage('Error obteniendo ubicación: ' + error.message);
            });
        } else {
            showErrorMessage('Geolocalización no soportada por este navegador.');
        }
    }

    function showSuccessMessage(message) {
        // Crear o actualizar mensaje de éxito
        showMessage(message, 'success');
    }

    function showErrorMessage(message) {
        // Crear o actualizar mensaje de error
        showMessage(message, 'error');
    }

    function showMessage(message, type) {
        // Remover mensaje anterior si existe
        const existingAlert = document.querySelector('.attendance-alert');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `attendance-alert fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md ${
            type === 'success' ? 'bg-green-100 border border-green-400 text-green-700' : 
            'bg-red-100 border border-red-400 text-red-700'
        }`;
        
        alertDiv.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
                <span class="text-sm">${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-lg leading-none">&times;</button>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Función para exportar datos (placeholder)
    window.exportAttendanceData = function() {
        showMessage('Funcionalidad de exportación en desarrollo', 'info');
    };

    // Actualizar estado cada 30 segundos para mantener sincronización
    setInterval(loadCurrentStatus, 30000);
</script>
{% endblock %}